name: Update Only Last Committed File

on:
  push:
    branches:
      - main  # change this to your target branch if needed

jobs:
  update-committed-file:
    runs-on: [self-hosted, linux, x64]

    steps:
      # 1Ô∏è‚É£ Checkout repository properly (so you don't need manual cloning)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensures full git history is available

      # 2Ô∏è‚É£ Show the runner workspace and current repo path
      - name: Show runner workspace
        run: |
          echo "üèóÔ∏è  GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "üìÅ Current directory:"
          pwd
          ls -la

      # 3Ô∏è‚É£ Get last committed files
      - name: Get last committed files
        id: last_commit
        run: |
          cd "$GITHUB_WORKSPACE"
          echo "üîç Detecting last commit files..."
          LAST_COMMIT=$(git rev-parse HEAD)
          echo "üß± Last commit SHA: $LAST_COMMIT"

          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LAST_COMMIT)
          echo "üìÑ Files changed in last commit:"
          echo "$CHANGED_FILES"

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Update only the last committed files in the same directory
      - name: Update changed files in existing directory
        run: |
          TARGET_DIR="$GITHUB_WORKSPACE"
          echo "üîß Updating changed files in: $TARGET_DIR"

          cd "$TARGET_DIR"
          echo "${{ steps.last_commit.outputs.changed_files }}" | while read file; do
            if [ -n "$file" ]; then
              echo "‚û°Ô∏è  Updating: $file"
              mkdir -p "$(dirname "$file")"
              git show HEAD:"$file" > "$file"
            fi
          done

          echo "‚úÖ Updated only the last committed files in $TARGET_DIR"

      # 5Ô∏è‚É£ Summary of what changed
      - name: Summary
        run: |
          echo "## üß© Code Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Updated folder: $GITHUB_WORKSPACE" >> $GITHUB_STEP_SUMMARY
          echo "- Changed files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.last_commit.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
